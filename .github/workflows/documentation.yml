name: Documentation Generation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ==============================================================================
  # GENERATE API DOCUMENTATION
  # ==============================================================================
  generate-api-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install sphinx sphinx-rtd-theme sphinx-autodoc-typehints
      
      - name: Generate OpenAPI spec
        run: |
          python -c "
          from app.main import app
          import json
          
          with open('docs/api/openapi.json', 'w') as f:
              json.dump(app.openapi(), f, indent=2)
          
          print('OpenAPI spec generated successfully!')
          "
      
      - name: Generate Sphinx documentation
        run: |
          cd docs
          sphinx-quickstart -q -p KeneyApp -a "ISData Consulting" -v 3.0 --ext-autodoc --ext-viewcode
          sphinx-build -b html . _build/html
      
      - name: Upload API documentation
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: |
            docs/api/openapi.json
            docs/_build/html/
          retention-days: 30

  # ==============================================================================
  # GENERATE FRONTEND DOCUMENTATION
  # ==============================================================================
  generate-frontend-docs:
    name: Generate Frontend Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'
      
      - name: Install dependencies
        working-directory: ./frontend
        run: |
          npm ci
          npm install --save-dev typedoc typedoc-plugin-markdown
      
      - name: Generate TypeDoc documentation
        working-directory: ./frontend
        run: |
          npx typedoc --out docs/typedoc \
            --plugin typedoc-plugin-markdown \
            --entryPoints src/index.tsx \
            --exclude "**/*.test.ts" \
            --exclude "**/*.test.tsx"
      
      - name: Upload frontend documentation
        uses: actions/upload-artifact@v4
        with:
          name: frontend-documentation
          path: frontend/docs/
          retention-days: 30

  # ==============================================================================
  # GENERATE DATABASE SCHEMA DOCUMENTATION
  # ==============================================================================
  generate-db-docs:
    name: Generate Database Documentation
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: keneyapp
          POSTGRES_PASSWORD: keneyapp
          POSTGRES_DB: keneyapp_docs
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install eralchemy2
      
      - name: Run database migrations
        env:
          DATABASE_URL: postgresql://keneyapp:keneyapp@localhost:5432/keneyapp_docs
        run: |
          alembic upgrade head
      
      - name: Generate ERD diagram
        env:
          DATABASE_URL: postgresql://keneyapp:keneyapp@localhost:5432/keneyapp_docs
        run: |
          eralchemy2 -i "$DATABASE_URL" -o docs/database/erd.png
          eralchemy2 -i "$DATABASE_URL" -o docs/database/erd.pdf
      
      - name: Generate schema documentation
        env:
          DATABASE_URL: postgresql://keneyapp:keneyapp@localhost:5432/keneyapp_docs
        run: |
          python scripts/generate_db_docs.py > docs/database/schema.md
      
      - name: Upload database documentation
        uses: actions/upload-artifact@v4
        with:
          name: database-documentation
          path: docs/database/
          retention-days: 30

  # ==============================================================================
  # BUILD & DEPLOY DOCUMENTATION SITE
  # ==============================================================================
  build-docs-site:
    name: Build Documentation Site
    runs-on: ubuntu-latest
    needs: [generate-api-docs, generate-frontend-docs, generate-db-docs]
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all documentation
        uses: actions/download-artifact@v4
        with:
          path: docs-artifacts/
      
      - name: Set up Node.js for Docusaurus
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Docusaurus (if not exists)
        run: |
          if [ ! -d "website" ]; then
            npx create-docusaurus@latest website classic --typescript
          fi
      
      - name: Copy documentation to Docusaurus
        run: |
          mkdir -p website/static/api
          mkdir -p website/static/db
          mkdir -p website/docs
          
          cp docs-artifacts/api-documentation/docs/api/openapi.json website/static/api/
          cp -r docs-artifacts/frontend-documentation/* website/docs/ || true
          cp -r docs-artifacts/database-documentation/* website/static/db/ || true
      
      - name: Build Docusaurus site
        working-directory: ./website
        run: |
          npm install
          npm run build
      
      - name: Upload documentation site
        uses: actions/upload-pages-artifact@v3
        with:
          path: website/build

  # ==============================================================================
  # DEPLOY TO GITHUB PAGES
  # ==============================================================================
  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: build-docs-site
    if: github.ref == 'refs/heads/main'
    # Note: Remove 'environment' block or create 'github-pages' environment in GitHub repo settings
    # environment:
    #   name: github-pages
    #   url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Comment PR with documentation link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deployment.outputs.page_url }}';
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `ðŸ“š Documentation deployed to: ${url}`
            });

  # ==============================================================================
  # UPDATE README BADGES
  # ==============================================================================
  update-readme-badges:
    name: Update README Badges
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update badges in README
        run: |
          # Get latest version
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v2.0.0")
          
          # Update badges (simplified example)
          sed -i "s|!\[Version\].*|![Version](https://img.shields.io/badge/version-${VERSION}-blue)|" README.md
          
          # Add more badge updates as needed
      
      - name: Commit README updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'docs: update README badges [skip ci]'
          file_pattern: 'README.md'
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
