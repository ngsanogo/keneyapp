name: SonarCloud Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: '0 2 * * 1' # Run every Monday at 2 AM UTC

jobs:
  sonarcloud:
    name: SonarCloud Code Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Run Python tests with coverage
        env:
          DATABASE_URL: sqlite:///./test.db
          SECRET_KEY: test-secret-key
          ENCRYPTION_KEY: test-encryption-key-32-chars-min
        run: |
          pytest tests/ -v \
            -m "not slow and not e2e" \
            --cov=app \
            --cov-report=xml:coverage.xml \
            --cov-report=term
        continue-on-error: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run frontend tests with coverage
        working-directory: ./frontend
        run: npm test -- --watchAll=false --coverage
        continue-on-error: true

      - name: Fix coverage paths for SonarCloud
        run: |
          sed -i 's|/home/runner/work/keneyapp/keneyapp|/github/workspace|g' coverage.xml
          sed -i 's|/home/runner/work/keneyapp/keneyapp/frontend|/github/workspace/frontend|g' frontend/coverage/lcov.info

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=ISData-consulting_keneyapp
            -Dsonar.organization=isdata-consulting
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.javascript.lcov.reportPaths=frontend/coverage/lcov.info
            -Dsonar.typescript.lcov.reportPaths=frontend/coverage/lcov.info
            -Dsonar.sources=app,frontend/src
            -Dsonar.tests=tests,frontend/src
            -Dsonar.test.inclusions=**/*.test.ts,**/*.test.tsx,**/test_*.py
            -Dsonar.exclusions=**/node_modules/**,**/migrations/**,**/__pycache__/**,**/build/**,**/dist/**,**/.venv/**
            -Dsonar.coverage.exclusions=**/tests/**,**/test_*.py,**/*.test.ts,**/*.test.tsx
            -Dsonar.python.version=3.11
            -Dsonar.qualitygate.wait=true

      - name: Check Quality Gate
        id: quality-gate-check
        run: |
          QUALITY_GATE_STATUS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=ISData-consulting_keneyapp" \
            | jq -r '.projectStatus.status')

          echo "Quality Gate Status: $QUALITY_GATE_STATUS"

          if [ "$QUALITY_GATE_STATUS" != "OK" ]; then
            echo "‚ùå Quality Gate Failed!"
            exit 1
          else
            echo "‚úÖ Quality Gate Passed!"
          fi
        continue-on-error: true

      - name: Comment PR with SonarCloud results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const projectKey = 'ISData-consulting_keneyapp';
            const prNumber = context.payload.pull_request.number;

            const comment = `## SonarCloud Analysis Results

            [üìä View detailed report on SonarCloud](https://sonarcloud.io/dashboard?id=${projectKey})

            Please check the quality gate status and address any issues before merging.`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
