name: Comprehensive CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  PYTHON_VERSION: "3.13"
  NODE_VERSION: "20"

jobs:
  # ============================================================================
  # QUICK CHECKS - Fail fast on obvious issues
  # ============================================================================
  quick-checks:
    name: Quick Checks (Lint & Format)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install flake8 black isort pylint
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Install Node dependencies
        working-directory: frontend
        run: npm ci

      - name: Flake8 Linting
        continue-on-error: false
        run: |
          flake8 app tests --max-line-length=120 --extend-ignore=E203,W503 \
            --count --statistics --show-source --benchmark
        
      - name: Black Format Check
        run: |
          black --check --line-length=100 --diff app tests

      - name: isort Import Check
        run: |
          isort --check-only --diff app tests

      - name: ESLint (Frontend)
        working-directory: frontend
        run: |
          npm run lint 2>&1 || true
        continue-on-error: true

      - name: Prettier Format Check (Frontend)
        working-directory: frontend
        run: |
          npx prettier --check "src/**/*.{ts,tsx,js,jsx,css}" || true
        continue-on-error: true

  # ============================================================================
  # BACKEND MATRIX - Test with multiple Python versions
  # ============================================================================
  backend-test:
    name: Backend Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: quick-checks
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
        include:
          - python-version: "3.13"
            coverage-report: true
            primary: true

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: keneyapp
          POSTGRES_PASSWORD: keneyapp_secure_pass
          POSTGRES_DB: keneyapp_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Wait for services
        run: |
          timeout 30 bash -c 'until pg_isready -h localhost -p 5432; do sleep 1; done'
          timeout 30 bash -c 'until redis-cli -h localhost -p 6379 ping; do sleep 1; done'

      - name: Run database migrations
        env:
          DATABASE_URL: postgresql://keneyapp:keneyapp_secure_pass@localhost:5432/keneyapp_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SECRET_KEY: test-secret-key-${{ matrix.python-version }}
          ENCRYPTION_KEY: test-encryption-key-32-chars-exactly!!
          ENVIRONMENT: test
        run: |
          alembic upgrade head

      - name: Run unit tests
        env:
          DATABASE_URL: postgresql://keneyapp:keneyapp_secure_pass@localhost:5432/keneyapp_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SECRET_KEY: test-secret-key-${{ matrix.python-version }}
          ENCRYPTION_KEY: test-encryption-key-32-chars-exactly!!
          ENVIRONMENT: test
        run: |
          pytest tests/ -v --tb=short \
            -m "not smoke and not integration" \
            --timeout=30 \
            --maxfail=3

      - name: Run unit tests with coverage
        if: matrix.coverage-report == true
        env:
          DATABASE_URL: postgresql://keneyapp:keneyapp_secure_pass@localhost:5432/keneyapp_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SECRET_KEY: test-secret-key-${{ matrix.python-version }}
          ENCRYPTION_KEY: test-encryption-key-32-chars-exactly!!
          ENVIRONMENT: test
        run: |
          pytest tests/ -v --tb=short \
            -m "not smoke and not integration" \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=70 \
            --timeout=30

      - name: Upload coverage to Codecov
        if: matrix.coverage-report == true
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: backend
          fail_ci_if_error: false

      - name: Upload coverage artifacts
        if: matrix.coverage-report == true
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-backend
          path: htmlcov/
          retention-days: 5

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-py${{ matrix.python-version }}
          path: |
            test-results.xml
            coverage.xml
          retention-days: 5

  # ============================================================================
  # FRONTEND MATRIX - Test with multiple Node versions
  # ============================================================================
  frontend-test:
    name: Frontend Tests (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs: quick-checks
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        node-version: ["18", "20", "22"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run linter
        working-directory: frontend
        run: npm run lint 2>&1 || true
        continue-on-error: true

      - name: Run tests
        working-directory: frontend
        run: npm test -- --watchAll=false --coverage
        continue-on-error: true

      - name: Upload coverage
        if: matrix.node-version == '20'
        uses: codecov/codecov-action@v3
        with:
          flags: frontend
          fail_ci_if_error: false

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-node${{ matrix.node-version }}
          path: frontend/build/
          retention-days: 1

  # ============================================================================
  # TYPE CHECKING - mypy for Python type safety
  # ============================================================================
  type-checking:
    name: Type Checking (mypy)
    runs-on: ubuntu-latest
    needs: quick-checks
    timeout-minutes: 15
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy
          pip install -r requirements.txt

      - name: Run mypy
        run: |
          mypy app --ignore-missing-imports --junit-xml=mypy-results.xml || true

      - name: Upload mypy results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mypy-results
          path: mypy-results.xml
          retention-days: 5

  # ============================================================================
  # SECURITY - Vulnerability scanning
  # ============================================================================
  security-check:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: quick-checks
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety pip-audit
          pip install -r requirements.txt

      - name: Bandit security scan (Python)
        run: |
          bandit -r app -f json -o bandit-report.json || true

      - name: Safety check (Dependencies)
        run: |
          safety check --json > safety-report.json || true

      - name: pip-audit (Dependency vulnerabilities)
        run: |
          pip-audit --desc > pip-audit-report.txt || true

      - name: OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          path: '.'
          format: 'JSON'
          args: >
            -l
            --enableExperimental

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
            pip-audit-report.txt
            dependency-check-report.json
          retention-days: 30

  # ============================================================================
  # INTEGRATION TESTS - Full system testing
  # ============================================================================
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    timeout-minutes: 45

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: keneyapp
          POSTGRES_PASSWORD: keneyapp_secure_pass
          POSTGRES_DB: keneyapp_integration
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Copy frontend to backend static
        run: |
          mkdir -p app/static
          cp -r frontend/build/* app/static/ 2>/dev/null || true

      - name: Run migrations
        env:
          DATABASE_URL: postgresql://keneyapp:keneyapp_secure_pass@localhost:5432/keneyapp_integration
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SECRET_KEY: test-secret-key
          ENCRYPTION_KEY: test-encryption-key-32-chars-exactly!!
          ENVIRONMENT: test
        run: |
          alembic upgrade head

      - name: Seed test database
        env:
          DATABASE_URL: postgresql://keneyapp:keneyapp_secure_pass@localhost:5432/keneyapp_integration
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SECRET_KEY: test-secret-key
          ENCRYPTION_KEY: test-encryption-key-32-chars-exactly!!
          ENVIRONMENT: test
        run: |
          python scripts/init_db.py

      - name: Start application
        env:
          DATABASE_URL: postgresql://keneyapp:keneyapp_secure_pass@localhost:5432/keneyapp_integration
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SECRET_KEY: test-secret-key
          ENCRYPTION_KEY: test-encryption-key-32-chars-exactly!!
          ENVIRONMENT: test
          LOG_LEVEL: info
        run: |
          timeout 30 python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5
          curl -f http://localhost:8000/health || exit 1

      - name: Run E2E integration tests
        env:
          DATABASE_URL: postgresql://keneyapp:keneyapp_secure_pass@localhost:5432/keneyapp_integration
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SECRET_KEY: test-secret-key
          ENCRYPTION_KEY: test-encryption-key-32-chars-exactly!!
          ENVIRONMENT: test
          API_URL: http://localhost:8000
        run: |
          pytest tests/ -v -m "integration" \
            --tb=short \
            --timeout=30 \
            --maxfail=3

      - name: Run E2E tests
        if: always()
        continue-on-error: true
        run: |
          bash scripts/run_e2e_tests.sh || true

      - name: Upload E2E artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: |
            tests/e2e/results/
            tests/e2e/screenshots/
          retention-days: 5

  # ============================================================================
  # PERFORMANCE BENCHMARKS
  # ============================================================================
  performance:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: backend-test
    timeout-minutes: 20
    continue-on-error: true

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: keneyapp
          POSTGRES_PASSWORD: keneyapp_secure_pass
          POSTGRES_DB: keneyapp_perf
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-benchmark pytest-html

      - name: Run performance tests
        env:
          DATABASE_URL: postgresql://keneyapp:keneyapp_secure_pass@localhost:5432/keneyapp_perf
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SECRET_KEY: test-secret-key
          ENCRYPTION_KEY: test-encryption-key-32-chars-exactly!!
          ENVIRONMENT: test
        run: |
          pytest tests/ -v -m "performance" \
            --benchmark-only \
            --benchmark-json=benchmark-results.json \
            --html=benchmark-report.html \
            --self-contained-html || true

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            benchmark-results.json
            benchmark-report.html
          retention-days: 5

  # ============================================================================
  # DOCUMENTATION VALIDATION
  # ============================================================================
  docs-validation:
    name: Documentation Validation
    runs-on: ubuntu-latest
    needs: quick-checks
    timeout-minutes: 10
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pydantic[docs] mkdocs mkdocs-material

      - name: Check markdown files
        run: |
          find docs -name "*.md" -type f | while read file; do
            if ! grep -q "^#" "$file"; then
              echo "Warning: $file has no markdown headings"
            fi
          done

      - name: Validate API documentation
        run: |
          find docs -name "API_*.md" -type f | wc -l | grep -q "^[0-9]" && echo "API docs found" || echo "Warning: No API docs"

      - name: Check broken links (attempt)
        continue-on-error: true
        run: |
          pip install markdown-link-check
          find docs -name "*.md" -type f -exec markdown-link-check {} \; || true

  # ============================================================================
  # BUILD & STAGING DEPLOYMENT
  # ============================================================================
  build-and-deploy:
    name: Build Docker Image & Deploy to Staging
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test, security-check, integration-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name == 'push' }}
          tags: ${{ env.REGISTRY }}/${{ github.repository }}:latest,${{ env.REGISTRY }}/${{ github.repository }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to staging
        if: github.event_name == 'push'
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_HOST: ${{ secrets.STAGING_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
          ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST \
            "docker pull ${{ env.REGISTRY }}/${{ github.repository }}:latest && \
             docker-compose -f docker-compose.staging.yml up -d"
        continue-on-error: true

  # ============================================================================
  # FINAL STATUS & NOTIFICATIONS
  # ============================================================================
  final-status:
    name: CI Pipeline Status
    runs-on: ubuntu-latest
    needs: [quick-checks, backend-test, frontend-test, type-checking, security-check, integration-test, performance, docs-validation]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Check if all jobs passed
        run: |
          if [[ "${{ needs.quick-checks.result }}" == "failure" ]] || \
             [[ "${{ needs.backend-test.result }}" == "failure" ]] || \
             [[ "${{ needs.frontend-test.result }}" == "failure" ]] || \
             [[ "${{ needs.security-check.result }}" == "failure" ]] || \
             [[ "${{ needs.integration-test.result }}" == "failure" ]]; then
            echo "Critical jobs failed - CI FAILED"
            exit 1
          fi
          echo "All critical tests passed - CI SUCCESS"

      - name: Slack notification on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "❌ CI Pipeline Failed for ${{ github.repository }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*CI Pipeline Failed* ❌\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref }}\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        continue-on-error: true

      - name: Comment on PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const message = `## CI Pipeline Results ✅
            
            - ✅ Linting & Formatting
            - ✅ Backend Tests (Python ${{ env.PYTHON_VERSION }})
            - ✅ Frontend Tests
            - ⚠️ Type Checking (non-blocking)
            - ✅ Security Checks
            - ✅ Integration Tests
            - ⚠️ Performance Tests (non-blocking)
            - ⚠️ Documentation (non-blocking)
            
            [View full workflow results](${context.payload.pull_request.html_url}/checks)`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
        continue-on-error: true
