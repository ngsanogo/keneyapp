name: Security Scan

on:
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'requirements.txt'
      - 'frontend/package.json'
      - 'frontend/package-lock.json'

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run pip-audit
      # pip-audit: exports human-readable output and artifacts (JSON + CycloneDX SBOM).
      # To make the job fail on findings, remove the '|| true' suffixes below.
      run: |
        pip install pip-audit
        pip-audit --desc --format json --output pip-audit-report.json || true
        pip-audit --desc --format cyclonedx-json --output sbom.json || true
        pip-audit --desc || true

    - name: Upload pip-audit report
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: pip-audit-report
        path: |
          pip-audit-report.json
          sbom.json
        retention-days: 30

    - name: Run Safety check
      # Safety runs in OSS mode by default. For Safety Pro, add a repo/org secret `SAFETY_API_KEY`
      # and pass it via env (uncomment lines below):
      # env:
      #   SAFETY_API_KEY: ${{ secrets.SAFETY_API_KEY }}
      # To make the job fail on findings, remove 'continue-on-error' and '|| true'.
      run: |
        pip install safety
        safety check --json --output safety-report.json || true
        safety check
      continue-on-error: true

    - name: Upload Safety report
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: safety-report
        path: safety-report.json
        retention-days: 30

  frontend-dependency-scan:
    name: Frontend Dependency Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: './frontend/package-lock.json'

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Run npm audit
      # npm audit: currently scans all deps. For production-only, you can run with '--omit=dev'.
      # To fail the job on findings, remove 'continue-on-error' and '|| true'.
      working-directory: ./frontend
      run: |
        # Example (prod-only): npm audit --omit=dev --json > npm-audit-report.json || true
        npm audit --json > npm-audit-report.json || true
        npm audit
      continue-on-error: true

    - name: Upload npm audit report
      if: always()
      uses: actions/upload-artifact@v5
      with:
        name: npm-audit-report
        path: frontend/npm-audit-report.json
        retention-days: 30

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0 # Full history for secret scanning

    - name: Run Gitleaks
      # Gitleaks runs in OSS mode by default. If you have a Pro license:
      # 1) Add a repo/org Actions secret named `GITLEAKS_LICENSE`.
      #    GitHub > Settings > Secrets and variables > Actions > New repository secret
      # 2) Uncomment the `GITLEAKS_LICENSE` line below to pass it to the action.
      uses: gitleaks/gitleaks-action@v2
      continue-on-error: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

    - name: Detect-secrets scan
      # detect-secrets: uses a baseline to track approved findings.
      # Update baseline when new detectors or files are introduced:
      #   detect-secrets scan > .secrets.baseline
      # Then audit interactively to review results:
      #   detect-secrets audit .secrets.baseline
      # Keep the baseline committed, but never commit actual secrets.
      run: |
        pip install detect-secrets
        detect-secrets scan --baseline .secrets.baseline --all-files || true
        detect-secrets audit .secrets.baseline || true
      continue-on-error: true

  trivy-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Run Trivy vulnerability scanner
      # Trivy filesystem scan with SARIF output for GitHub Security tab.
      # Adjust severity as needed. To ignore unfixed vulns, consider (commented):
      #   ignore-unfixed: true
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'

    - name: Upload Trivy results to GitHub Security
      # SARIF upload publishes results under the repo Security tab (Code scanning alerts).
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      continue-on-error: true
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run Trivy (table output)
      # Human-readable table in the job logs for quick triage.
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        severity: 'CRITICAL,HIGH,MEDIUM'
